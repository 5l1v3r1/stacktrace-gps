(function(root,factory){"use strict";if(typeof define==="function"&&define.amd){define("stacktrace-gps",["source-map","es6-promise","stackframe"],factory)}else if(typeof exports==="object"){module.exports=factory(require("source-map/lib/source-map/source-map-consumer"),require("es6-promise"),require("stackframe"))}else{root.StackTraceGPS=factory(root.SourceMap,root.ES6Promise,root.StackFrame)}})(this,function(SourceMap,ES6Promise,StackFrame){"use strict";ES6Promise.polyfill();var Promise=ES6Promise.Promise;function _createXMLHTTPObject(){var xmlhttp;var XMLHttpFactories=[function(){return new XMLHttpRequest},function(){return new ActiveXObject("Microsoft.XMLHTTP")}];for(var i=0;i<XMLHttpFactories.length;i++){try{xmlhttp=XMLHttpFactories[i]();_createXMLHTTPObject=XMLHttpFactories[i];return xmlhttp}catch(e){}}}function _xdr(url,callback,errback){var req=_createXMLHTTPObject();req.open("get",url);req.onerror=errback;req.onreadystatechange=function onreadystatechange(){if(req.readyState===4){if(req.status>=200&&req.status<400){return callback(req.responseText)}else{errback(new Error("Unable to retrieve "+url))}}};req.send()}function _findFunctionName(source,lineNumber,columnNumber){var reFunctionDeclaration=/function\s+([^(]*?)\s*\(([^)]*)\)/;var reFunctionExpression=/['"]?([$_A-Za-z][$_A-Za-z0-9]*)['"]?\s*[:=]\s*function\b/;var reFunctionEvaluation=/['"]?([$_A-Za-z][$_A-Za-z0-9]*)['"]?\s*[:=]\s*(?:eval|new Function)\b/;var lines=source.split("\n");var code="",line,maxLines=Math.min(lineNumber,20),m,commentPos;for(var i=0;i<maxLines;++i){line=lines[lineNumber-i-1];commentPos=line.indexOf("//");if(commentPos>=0){line=line.substr(0,commentPos)}if(line){code=line+code;m=reFunctionExpression.exec(code);if(m&&m[1]){return m[1]}m=reFunctionDeclaration.exec(code);if(m&&m[1]){return m[1]}m=reFunctionEvaluation.exec(code);if(m&&m[1]){return m[1]}}}return undefined}function _ensureSupportedEnvironment(){if(typeof Object.defineProperty!=="function"||typeof Object.create!=="function"){throw new Error("Unable to consume source maps in older browsers")}}function _ensureStackFrameIsLegit(stackframe){if(typeof stackframe!=="object"){throw new TypeError("Given StackFrame is not an object")}else if(typeof stackframe.fileName!=="string"){throw new TypeError("Given file name is not a String")}else if(typeof stackframe.lineNumber!=="number"||stackframe.lineNumber%1!==0||stackframe.lineNumber<1){throw new TypeError("Given line number must be a positive integer")}else if(typeof stackframe.columnNumber!=="number"||stackframe.columnNumber%1!==0||stackframe.columnNumber<0){throw new TypeError("Given column number must be a non-negative integer")}return true}function _findSourceMappingURL(source){var m=/\/\/[#@] ?sourceMappingURL=([^\s'"]+)$/.exec(source);if(m&&m[1]){return m[1]}else{throw new Error("sourceMappingURL not found")}}function _newLocationInfoFromSourceMap(rawSourceMap,args,lineNumber,columnNumber){var loc=new SourceMap.SourceMapConsumer(rawSourceMap).originalPositionFor({line:lineNumber,column:columnNumber});return new StackFrame(loc.name,args,loc.source,loc.line,loc.column)}return function StackTraceGPS(opts){if(!(this instanceof StackTraceGPS)){return new StackTraceGPS(opts)}opts=opts||{};this.sourceCache=opts.sourceCache||{};this.ajax=_xdr;this._get=function _get(location){return new Promise(function(resolve,reject){if(this.sourceCache[location]){resolve(this.sourceCache[location])}else if(opts.offline){reject(new Error("Cannot make network requests in offline mode"))}else{this.ajax(location,function(source){this.sourceCache[location]=source;resolve(source)}.bind(this),reject)}}.bind(this))};this.pinpoint=function StackTraceGPS$$pinpoint(stackframe){return new Promise(function(resolve,reject){this.getMappedLocation(stackframe).then(function(mappedStackFrame){function resolveMappedStackFrame(){resolve(mappedStackFrame)}this.findFunctionName(mappedStackFrame).then(resolve,resolveMappedStackFrame)["catch"](resolveMappedStackFrame)}.bind(this),reject)}.bind(this))};this.findFunctionName=function StackTraceGPS$$findFunctionName(stackframe){return new Promise(function(resolve,reject){_ensureStackFrameIsLegit(stackframe);this._get(stackframe.fileName).then(function getSourceCallback(source){var guessedFunctionName=_findFunctionName(source,stackframe.lineNumber,stackframe.columnNumber);resolve(new StackFrame(guessedFunctionName,stackframe.args,stackframe.fileName,stackframe.lineNumber,stackframe.columnNumber))},reject)}.bind(this))};this.getMappedLocation=function StackTraceGPS$$getMappedLocation(stackframe){return new Promise(function(resolve,reject){_ensureSupportedEnvironment();_ensureStackFrameIsLegit(stackframe);this._get(stackframe.fileName).then(function(source){this._get(_findSourceMappingURL(source)).then(function(map){var lineNumber=stackframe.lineNumber;var columnNumber=stackframe.columnNumber;resolve(_newLocationInfoFromSourceMap(map,stackframe.args,lineNumber,columnNumber))},reject)["catch"](reject)}.bind(this),reject)["catch"](reject)}.bind(this))}}});
//@ sourceMappingURL=stacktrace-gps.js.map